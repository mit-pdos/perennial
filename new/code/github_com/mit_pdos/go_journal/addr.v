(* autogenerated from github.com/mit-pdos/go-journal/addr *)
Require Export New.code.github_com.goose_lang.primitive.disk.
Require Export New.code.github_com.mit_pdos.go_journal.common.
From New.golang Require Import defn.
From New Require Import disk_prelude.
Module pkg_id.
Definition addr : go_string := "github.com/mit-pdos/go-journal/addr".

End pkg_id.
Export pkg_id.
Module addr.

Definition Addr {ext : ffi_syntax} {go_gctx : GoGlobalContext} : go.type := go.Named "github.com/mit-pdos/go-journal/addr.Addr"%go [].

Definition MkAddr {ext : ffi_syntax} {go_gctx : GoGlobalContext} : go_string := "github.com/mit-pdos/go-journal/addr.MkAddr"%go.

Definition MkBitAddr {ext : ffi_syntax} {go_gctx : GoGlobalContext} : go_string := "github.com/mit-pdos/go-journal/addr.MkBitAddr"%go.

(* go: addr.go:19:15 *)
Definition Addr__Flatidⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: "a" <>,
    exception_do (let: "a" := (GoAlloc Addr "a") in
    return: (((![common.Bnum] (StructFieldRef Addr "Blkno"%go "a")) *⟨go.uint64⟩ (disk.BlockSize *⟨go.uint64⟩ #(W64 8))) +⟨go.uint64⟩ (![go.uint64] (StructFieldRef Addr "Off"%go "a")))).

(* go: addr.go:23:6 *)
Definition MkAddrⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: "blkno" "off",
    exception_do (let: "off" := (GoAlloc go.uint64 "off") in
    let: "blkno" := (GoAlloc common.Bnum "blkno") in
    return: (CompositeLiteral Addr (LiteralValue [KeyedElement (Some (KeyField "Blkno"%go)) (ElementExpression common.Bnum (![common.Bnum] "blkno")); KeyedElement (Some (KeyField "Off"%go)) (ElementExpression go.uint64 (![go.uint64] "off"))]))).

(* go: addr.go:27:6 *)
Definition MkBitAddrⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: "start" "n",
    exception_do (let: "n" := (GoAlloc go.uint64 "n") in
    let: "start" := (GoAlloc common.Bnum "start") in
    let: "bit" := (GoAlloc go.uint64 (GoZeroVal go.uint64 #())) in
    let: "$r0" := ((![go.uint64] "n") %⟨go.uint64⟩ common.NBITBLOCK) in
    do:  ("bit" <-[go.uint64] "$r0");;;
    let: "i" := (GoAlloc go.uint64 (GoZeroVal go.uint64 #())) in
    let: "$r0" := ((![go.uint64] "n") /⟨go.uint64⟩ common.NBITBLOCK) in
    do:  ("i" <-[go.uint64] "$r0");;;
    let: "addr" := (GoAlloc Addr (GoZeroVal Addr #())) in
    let: "$r0" := (let: "$a0" := ((![common.Bnum] "start") +⟨go.uint64⟩ (![go.uint64] "i")) in
    let: "$a1" := (![go.uint64] "bit") in
    (FuncResolve MkAddr [] #()) "$a0" "$a1") in
    do:  ("addr" <-[Addr] "$r0");;;
    return: (![Addr] "addr")).

#[global] Instance info' : PkgInfo pkg_id.addr :=
{|
  pkg_imported_pkgs := [code.github_com.goose_lang.primitive.disk.pkg_id.disk; code.github_com.mit_pdos.go_journal.common.pkg_id.common]
|}.

Definition initialize' {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: <>,
    package.init pkg_id.addr (λ: <>,
      exception_do (do:  (common.initialize' #());;;
      do:  (disk.initialize' #()))
      ).

Module Addr.
Section def.
Context {ext : ffi_syntax} {go_gctx : GoGlobalContext}.
Record t :=
mk {
  Blkno' : w64;
  Off' : w64;
}.

#[global] Instance zero_val : ZeroVal t := {| zero_val := mk (zero_val _) (zero_val _)|}.
#[global] Arguments mk : clear implicits.
#[global] Arguments t : clear implicits.
End def.

End Addr.

Definition Addr'fds_unsealed {ext : ffi_syntax} {go_gctx : GoGlobalContext} : list go.field_decl := [
  (go.FieldDecl "Blkno"%go common.Bnum);
  (go.FieldDecl "Off"%go go.uint64)
].
Program Definition Addr'fds {ext : ffi_syntax} {go_gctx : GoGlobalContext} := sealed (Addr'fds_unsealed).
Global Instance equals_unfold_Addr {ext : ffi_syntax} {go_gctx : GoGlobalContext} : Addr'fds =→ Addr'fds_unsealed.
Proof. rewrite /Addr'fds seal_eq //. Qed.

Definition Addrⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : go.type := go.StructType (Addr'fds).

Class Addr_Assumptions {ext : ffi_syntax} `{!GoGlobalContext} `{!GoLocalContext} `{!GoSemanticsFunctions} : Prop :=
{
  #[global] Addr_type_repr  :: go.TypeReprUnderlying Addrⁱᵐᵖˡ Addr.t;
  #[global] Addr_underlying :: (Addr) <u (Addrⁱᵐᵖˡ);
  #[global] Addr_get_Blkno (x : Addr.t) :: ⟦StructFieldGet (Addrⁱᵐᵖˡ) "Blkno", #x⟧ ⤳[under] #x.(Addr.Blkno');
  #[global] Addr_set_Blkno (x : Addr.t) y :: ⟦StructFieldSet (Addrⁱᵐᵖˡ) "Blkno", (#x, #y)⟧ ⤳[under] #(x <|Addr.Blkno' := y|>);
  #[global] Addr_get_Off (x : Addr.t) :: ⟦StructFieldGet (Addrⁱᵐᵖˡ) "Off", #x⟧ ⤳[under] #x.(Addr.Off');
  #[global] Addr_set_Off (x : Addr.t) y :: ⟦StructFieldSet (Addrⁱᵐᵖˡ) "Off", (#x, #y)⟧ ⤳[under] #(x <|Addr.Off' := y|>);
  #[global] Addr_Flatid_unfold :: MethodUnfold (Addr) "Flatid" (Addr__Flatidⁱᵐᵖˡ);
  #[global] Addr'ptr_Flatid_unfold :: MethodUnfold (go.PointerType (Addr)) "Flatid" (λ: "$r", MethodResolve (Addr) "Flatid" (![(Addr)] "$r"));
}.

Class Assumptions `{!GoGlobalContext} `{!GoLocalContext} `{!GoSemanticsFunctions} : Prop :=
{
  #[global] Addr_instance :: Addr_Assumptions;
  #[global] MkAddr_unfold :: FuncUnfold MkAddr [] (MkAddrⁱᵐᵖˡ);
  #[global] MkBitAddr_unfold :: FuncUnfold MkBitAddr [] (MkBitAddrⁱᵐᵖˡ);
  #[global] import_disk_Assumption :: disk.Assumptions;
  #[global] import_common_Assumption :: common.Assumptions;
}.
End addr.
