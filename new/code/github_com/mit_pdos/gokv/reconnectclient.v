(* autogenerated from github.com/mit-pdos/gokv/reconnectclient *)
Require Export New.code.sync.
Require Export New.code.github_com.goose_lang.primitive.
Require Export New.code.github_com.mit_pdos.gokv.grove_ffi.
Require Export New.code.github_com.mit_pdos.gokv.urpc.
From New.golang Require Import defn.
From New Require Import grove_prelude.
Module pkg_id.
Definition reconnectclient : go_string := "github.com/mit-pdos/gokv/reconnectclient".

End pkg_id.
Export pkg_id.
Module reconnectclient.

Definition ReconnectingClient {ext : ffi_syntax} {go_gctx : GoGlobalContext} : go.type := go.Named "github.com/mit-pdos/gokv/reconnectclient.ReconnectingClient"%go [].

Definition MakeReconnectingClient {ext : ffi_syntax} {go_gctx : GoGlobalContext} : go_string := "github.com/mit-pdos/gokv/reconnectclient.MakeReconnectingClient"%go.

(* go: client.go:20:6 *)
Definition MakeReconnectingClientⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: "addr",
    exception_do (let: "addr" := (GoAlloc grove_ffi.Address "addr") in
    let: "r" := (GoAlloc (go.PointerType ReconnectingClient) (GoZeroVal (go.PointerType ReconnectingClient) #())) in
    let: "$r0" := (GoAlloc ReconnectingClient (GoZeroVal ReconnectingClient #())) in
    do:  ("r" <-[go.PointerType ReconnectingClient] "$r0");;;
    let: "$r0" := (GoAlloc sync.Mutex (GoZeroVal sync.Mutex #())) in
    do:  ((StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "r")) <-[go.PointerType sync.Mutex] "$r0");;;
    let: "$r0" := #false in
    do:  ((StructFieldRef ReconnectingClient "valid"%go (![go.PointerType ReconnectingClient] "r")) <-[go.bool] "$r0");;;
    let: "$r0" := (![grove_ffi.Address] "addr") in
    do:  ((StructFieldRef ReconnectingClient "addr"%go (![go.PointerType ReconnectingClient] "r")) <-[grove_ffi.Address] "$r0");;;
    return: (![go.PointerType ReconnectingClient] "r")).

(* go: client.go:30:31 *)
Definition ReconnectingClient__getClientⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: "cl" <>,
    exception_do (let: "cl" := (GoAlloc (go.PointerType ReconnectingClient) "cl") in
    do:  ((MethodResolve (go.PointerType sync.Mutex) "Lock"%go (![go.PointerType sync.Mutex] (StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "cl")))) #());;;
    (if: ![go.bool] (StructFieldRef ReconnectingClient "valid"%go (![go.PointerType ReconnectingClient] "cl"))
    then
      let: "ret" := (GoAlloc (go.PointerType urpc.Client) (GoZeroVal (go.PointerType urpc.Client) #())) in
      let: "$r0" := (![go.PointerType urpc.Client] (StructFieldRef ReconnectingClient "urpcCl"%go (![go.PointerType ReconnectingClient] "cl"))) in
      do:  ("ret" <-[go.PointerType urpc.Client] "$r0");;;
      do:  ((MethodResolve (go.PointerType sync.Mutex) "Unlock"%go (![go.PointerType sync.Mutex] (StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "cl")))) #());;;
      return: (#(W64 0), ![go.PointerType urpc.Client] "ret")
    else do:  #());;;
    do:  ((MethodResolve (go.PointerType sync.Mutex) "Unlock"%go (![go.PointerType sync.Mutex] (StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "cl")))) #());;;
    let: "newRpcCl" := (GoAlloc (go.PointerType urpc.Client) (GoZeroVal (go.PointerType urpc.Client) #())) in
    let: "err" := (GoAlloc go.uint64 (GoZeroVal go.uint64 #())) in
    let: ("$ret0", "$ret1") := (let: "$a0" := (![grove_ffi.Address] (StructFieldRef ReconnectingClient "addr"%go (![go.PointerType ReconnectingClient] "cl"))) in
    (FuncResolve urpc.TryMakeClient [] #()) "$a0") in
    let: "$r0" := "$ret0" in
    let: "$r1" := "$ret1" in
    do:  ("err" <-[go.uint64] "$r0");;;
    do:  ("newRpcCl" <-[go.PointerType urpc.Client] "$r1");;;
    (if: Convert go.untyped_bool go.bool ((![go.uint64] "err") ≠⟨go.uint64⟩ #(W64 0))
    then
      do:  (let: "$a0" := #(W64 10000000) in
      (FuncResolve primitive.Sleep [] #()) "$a0")
    else do:  #());;;
    do:  ((MethodResolve (go.PointerType sync.Mutex) "Lock"%go (![go.PointerType sync.Mutex] (StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "cl")))) #());;;
    (if: Convert go.untyped_bool go.bool ((![go.uint64] "err") =⟨go.uint64⟩ #(W64 0))
    then
      let: "$r0" := (![go.PointerType urpc.Client] "newRpcCl") in
      do:  ((StructFieldRef ReconnectingClient "urpcCl"%go (![go.PointerType ReconnectingClient] "cl")) <-[go.PointerType urpc.Client] "$r0");;;
      let: "$r0" := #true in
      do:  ((StructFieldRef ReconnectingClient "valid"%go (![go.PointerType ReconnectingClient] "cl")) <-[go.bool] "$r0")
    else do:  #());;;
    do:  ((MethodResolve (go.PointerType sync.Mutex) "Unlock"%go (![go.PointerType sync.Mutex] (StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "cl")))) #());;;
    return: (![go.uint64] "err", ![go.PointerType urpc.Client] "newRpcCl")).

(* go: client.go:63:31 *)
Definition ReconnectingClient__Callⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: "cl" "rpcid" "args" "reply" "timeout_ms",
    exception_do (let: "cl" := (GoAlloc (go.PointerType ReconnectingClient) "cl") in
    let: "timeout_ms" := (GoAlloc go.uint64 "timeout_ms") in
    let: "reply" := (GoAlloc (go.PointerType (go.SliceType go.byte)) "reply") in
    let: "args" := (GoAlloc (go.SliceType go.byte) "args") in
    let: "rpcid" := (GoAlloc go.uint64 "rpcid") in
    let: "urpcCl" := (GoAlloc (go.PointerType urpc.Client) (GoZeroVal (go.PointerType urpc.Client) #())) in
    let: "err1" := (GoAlloc go.uint64 (GoZeroVal go.uint64 #())) in
    let: ("$ret0", "$ret1") := ((MethodResolve (go.PointerType ReconnectingClient) "getClient"%go (![go.PointerType ReconnectingClient] "cl")) #()) in
    let: "$r0" := "$ret0" in
    let: "$r1" := "$ret1" in
    do:  ("err1" <-[go.uint64] "$r0");;;
    do:  ("urpcCl" <-[go.PointerType urpc.Client] "$r1");;;
    (if: Convert go.untyped_bool go.bool ((![go.uint64] "err1") ≠⟨go.uint64⟩ #(W64 0))
    then return: (![go.uint64] "err1")
    else do:  #());;;
    let: "err" := (GoAlloc urpc.Error (GoZeroVal urpc.Error #())) in
    let: "$r0" := (let: "$a0" := (![go.uint64] "rpcid") in
    let: "$a1" := (![go.SliceType go.byte] "args") in
    let: "$a2" := (![go.PointerType (go.SliceType go.byte)] "reply") in
    let: "$a3" := (![go.uint64] "timeout_ms") in
    (MethodResolve (go.PointerType urpc.Client) "Call"%go (![go.PointerType urpc.Client] "urpcCl")) "$a0" "$a1" "$a2" "$a3") in
    do:  ("err" <-[urpc.Error] "$r0");;;
    (if: Convert go.untyped_bool go.bool ((![urpc.Error] "err") =⟨go.uint64⟩ urpc.ErrDisconnect)
    then
      do:  ((MethodResolve (go.PointerType sync.Mutex) "Lock"%go (![go.PointerType sync.Mutex] (StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "cl")))) #());;;
      let: "$r0" := #false in
      do:  ((StructFieldRef ReconnectingClient "valid"%go (![go.PointerType ReconnectingClient] "cl")) <-[go.bool] "$r0");;;
      do:  ((MethodResolve (go.PointerType sync.Mutex) "Unlock"%go (![go.PointerType sync.Mutex] (StructFieldRef ReconnectingClient "mu"%go (![go.PointerType ReconnectingClient] "cl")))) #())
    else do:  #());;;
    return: (![urpc.Error] "err")).

#[global] Instance info' : PkgInfo pkg_id.reconnectclient :=
{|
  pkg_imported_pkgs := [code.sync.pkg_id.sync; code.github_com.goose_lang.primitive.pkg_id.primitive; code.github_com.mit_pdos.gokv.grove_ffi.pkg_id.grove_ffi; code.github_com.mit_pdos.gokv.urpc.pkg_id.urpc]
|}.

Definition initialize' {ext : ffi_syntax} {go_gctx : GoGlobalContext} : val :=
  λ: <>,
    package.init pkg_id.reconnectclient (λ: <>,
      exception_do (do:  (urpc.initialize' #());;;
      do:  (grove_ffi.initialize' #());;;
      do:  (primitive.initialize' #());;;
      do:  (sync.initialize' #()))
      ).

Module ReconnectingClient.
Section def.
Context {ext : ffi_syntax} {go_gctx : GoGlobalContext}.
Record t :=
mk {
  mu' : loc;
  valid' : bool;
  urpcCl' : loc;
  addr' : w64;
}.

#[global] Instance zero_val : ZeroVal t := {| zero_val := mk (zero_val _) (zero_val _) (zero_val _) (zero_val _)|}.
#[global] Arguments mk : clear implicits.
#[global] Arguments t : clear implicits.
End def.

End ReconnectingClient.

Definition ReconnectingClient'fds_unsealed {ext : ffi_syntax} {go_gctx : GoGlobalContext} : list go.field_decl := [
  (go.FieldDecl "mu"%go (go.PointerType sync.Mutex));
  (go.FieldDecl "valid"%go go.bool);
  (go.FieldDecl "urpcCl"%go (go.PointerType urpc.Client));
  (go.FieldDecl "addr"%go grove_ffi.Address)
].
Program Definition ReconnectingClient'fds {ext : ffi_syntax} {go_gctx : GoGlobalContext} := sealed (ReconnectingClient'fds_unsealed).
Global Instance equals_unfold_ReconnectingClient {ext : ffi_syntax} {go_gctx : GoGlobalContext} : ReconnectingClient'fds =→ ReconnectingClient'fds_unsealed.
Proof. rewrite /ReconnectingClient'fds seal_eq //. Qed.

Definition ReconnectingClientⁱᵐᵖˡ {ext : ffi_syntax} {go_gctx : GoGlobalContext} : go.type := go.StructType (ReconnectingClient'fds).

Class ReconnectingClient_Assumptions {ext : ffi_syntax} `{!GoGlobalContext} `{!GoLocalContext} `{!GoSemanticsFunctions} : Prop :=
{
  #[global] ReconnectingClient_type_repr  :: go.TypeReprUnderlying ReconnectingClientⁱᵐᵖˡ ReconnectingClient.t;
  #[global] ReconnectingClient_underlying :: (ReconnectingClient) <u (ReconnectingClientⁱᵐᵖˡ);
  #[global] ReconnectingClient_get_mu (x : ReconnectingClient.t) :: ⟦StructFieldGet (ReconnectingClientⁱᵐᵖˡ) "mu", #x⟧ ⤳[under] #x.(ReconnectingClient.mu');
  #[global] ReconnectingClient_set_mu (x : ReconnectingClient.t) y :: ⟦StructFieldSet (ReconnectingClientⁱᵐᵖˡ) "mu", (#x, #y)⟧ ⤳[under] #(x <|ReconnectingClient.mu' := y|>);
  #[global] ReconnectingClient_get_valid (x : ReconnectingClient.t) :: ⟦StructFieldGet (ReconnectingClientⁱᵐᵖˡ) "valid", #x⟧ ⤳[under] #x.(ReconnectingClient.valid');
  #[global] ReconnectingClient_set_valid (x : ReconnectingClient.t) y :: ⟦StructFieldSet (ReconnectingClientⁱᵐᵖˡ) "valid", (#x, #y)⟧ ⤳[under] #(x <|ReconnectingClient.valid' := y|>);
  #[global] ReconnectingClient_get_urpcCl (x : ReconnectingClient.t) :: ⟦StructFieldGet (ReconnectingClientⁱᵐᵖˡ) "urpcCl", #x⟧ ⤳[under] #x.(ReconnectingClient.urpcCl');
  #[global] ReconnectingClient_set_urpcCl (x : ReconnectingClient.t) y :: ⟦StructFieldSet (ReconnectingClientⁱᵐᵖˡ) "urpcCl", (#x, #y)⟧ ⤳[under] #(x <|ReconnectingClient.urpcCl' := y|>);
  #[global] ReconnectingClient_get_addr (x : ReconnectingClient.t) :: ⟦StructFieldGet (ReconnectingClientⁱᵐᵖˡ) "addr", #x⟧ ⤳[under] #x.(ReconnectingClient.addr');
  #[global] ReconnectingClient_set_addr (x : ReconnectingClient.t) y :: ⟦StructFieldSet (ReconnectingClientⁱᵐᵖˡ) "addr", (#x, #y)⟧ ⤳[under] #(x <|ReconnectingClient.addr' := y|>);
  #[global] ReconnectingClient'ptr_Call_unfold :: MethodUnfold (go.PointerType (ReconnectingClient)) "Call" (ReconnectingClient__Callⁱᵐᵖˡ);
  #[global] ReconnectingClient'ptr_getClient_unfold :: MethodUnfold (go.PointerType (ReconnectingClient)) "getClient" (ReconnectingClient__getClientⁱᵐᵖˡ);
}.

Class Assumptions `{!GoGlobalContext} `{!GoLocalContext} `{!GoSemanticsFunctions} : Prop :=
{
  #[global] ReconnectingClient_instance :: ReconnectingClient_Assumptions;
  #[global] MakeReconnectingClient_unfold :: FuncUnfold MakeReconnectingClient [] (MakeReconnectingClientⁱᵐᵖˡ);
  #[global] import_sync_Assumption :: sync.Assumptions;
  #[global] import_primitive_Assumption :: primitive.Assumptions;
  #[global] import_grove_ffi_Assumption :: grove_ffi.Assumptions;
  #[global] import_urpc_Assumption :: urpc.Assumptions;
}.
End reconnectclient.
